<?php

//这段代码是PHP语言的，主要用于设置一些常量和环境变量。下面是对每一行代码的解释：
//1. `error_reporting(0);`：这行代码将错误报告级别设置为0，这意味着PHP不会显示任何错误或警告信息。
//
//2. `session_start();`：这行代码启动一个新的会话。在Web开发中，会话用于跟踪用户的状态和行为。
//
//3. `define('BASE_PATH',str_replace('\\','/',dirname(__FILE__))."/");`：这行代码定义了一个常量`BASE_PATH`，它的值是当前文件所在目录的路径，所有的斜杠都被替换为正斜杠。
//
//4. `define('ROOT_PATH',str_replace('app/','',BASE_PATH));`：这行代码定义了一个常量`ROOT_PATH`，它的值是`BASE_PATH`去掉'app/'后的结果。
//
//5. `define('MSGFILE','app/MSG.txt');`：这行代码定义了一个常量`MSGFILE`，它的值是'app/MSG.txt'。
//
//6. `define('NUMFILE','app/NUM.txt');`：这行代码定义了一个常量`NUMFILE`，它的值是'app/NUM.txt'。
//
//7. `define('KEYS','bskdl87');`：这行代码定义了一个常量`KEYS`，它的值是'bskdl87'。
//
//8. `define('LSTR','admin');`：这行代码定义了一个常量`LSTR`，它的值是'admin'。
//
//9. `date_default_timezone_set('PRC');`：这行代码将默认时区设置为'PRC'（中国标准时间）。
error_reporting(0);
session_start();
define('BASE_PATH',str_replace('\\','/',dirname(__FILE__))."/");
define('ROOT_PATH',str_replace('app/','',BASE_PATH));

define('MSGFILE','app/MSG.txt');

define('NUMFILE','app/NUM.txt');

define('KEYS','bskdl87'); 
define('LSTR','admin');

date_default_timezone_set('PRC');

//这是一个PHP函数，名为`nick`，接受一个参数`$user`。
//如果`$user`为空，函数会调用`rand_nick()`函数生成一个随机昵称；
//否则，使用传入的`$user`作为昵称。
//然后，函数创建一个包含当前时间、消息类型（系统消息）和昵称的消息数组，
//并将其转换为JSON格式。接着，函数创建另一个包含系统消息、消息类型和昵称的消息数组，
//并将其添加到之前创建的JSON字符串中。最后，函数将这个JSON字符串追加到`MSGFILE`文件中，
//并设置两个cookie：一个是`KEYS`加上`_key`，值为一个唯一的ID；另一个是`KEYS`加上`_name`，
//值为经过URL编码的昵称。函数返回一个包含昵称和唯一ID的数组。
function nick($user=''){
if(empty($user)){ 
    $name=rand_nick();
}else{
    $name = $user;
} 
    $arr['msg'] = '<span>'.date('Y-m-d H:i').'</span>';
	$arr['type']= 'sys';
	$str = json_encode($arr);
	$arr['msg'] = '<span class="tips-warning">系统消息：<strong>'.$name.'</strong>进入聊天室</span>';
	$arr['type']= 'sys';

	$str = $str."\n".json_encode($arr);
	file_put_contents(ROOT_PATH.MSGFILE, $str."\n" , FILE_APPEND|LOCK_EX);


	$key = uniqid();

    setcookie(KEYS.'_key',$key,time()+3600*24*90,'/');
    setcookie(KEYS.'_name',urlencode($name),time()+3600*24*30,'/');

    return array('name'=>$name,'key'=>$key); //输出生成的昵称
} 


//这是一个PHP函数，名为`rand_nick`。
//它首先定义了两个数组：`$name_tou`和`$name_wei`，
//分别包含一些中文昵称的形容词和名词。然后，函数生成两个随机数`$t`和`$w`，
//分别作为索引从这两个数组中选取一个元素，将它们连接起来形成一个昵称，并返回这个昵称。
function rand_nick(){
  $name_tou=array(
  '快乐的','冷静的','醉熏的','潇洒的','糊涂的','积极的','冷酷的','深情的','粗暴的','温柔的','可爱的','愉快的','义气的','认真的','威武的','帅气的','传统的','潇洒的','漂亮的','自然的','专一的','听话的','昏睡的','狂野的','等待的','搞怪的','幽默的','魁梧的','活泼的','开心的','高兴的','超帅的','坦率的','直率的','轻松的','痴情的','完美的','精明的','无聊的','丰富的','繁荣的','饱满的','炙热的','暴躁的','碧蓝的','俊逸的','英勇的','健忘的','故意的','无心的','土豪的','朴实的','兴奋的','幸福的','淡定的','不安的','阔达的','孤独的','独特的','疯狂的','时尚的','落后的','风趣的','忧伤的','大胆的','爱笑的','矮小的','健康的','合适的','玩命的','沉默的','斯文的','任性的','细心的','粗心的','大意的','甜甜的','酷酷的','健壮的','英俊的','霸气的','阳光的','默默的','大力的','孝顺的','忧虑的','着急的','紧张的','善良的','凶狠的','害怕的','重要的','危机的','欢喜的','欣慰的','满意的','跳跃的','诚心的','称心的','如意的','怡然的','娇气的','无奈的','无语的','激动的','愤怒的','美好的','感动的','激情的','激昂的','震动的','虚拟的','超级的','寒冷的','精明的','明理的','犹豫的','忧郁的','寂寞的','奋斗的','勤奋的','现代的','过时的','稳重的','热情的','含蓄的','开放的','无辜的','多情的','纯真的','拉长的','热心的','从容的','体贴的','风中的','曾经的','追寻的','儒雅的','优雅的','开朗的','外向的','内向的','清爽的','文艺的','长情的','平常的','单身的','伶俐的','高大的','懦弱的','柔弱的','爱笑的','乐观的','耍酷的','酷炫的','神勇的','年轻的','唠叨的','瘦瘦的','无情的','包容的','顺心的','畅快的','舒适的','靓丽的','负责的','背后的','简单的','谦让的','彩色的','缥缈的','欢呼的','生动的','复杂的','慈祥的','仁爱的','魔幻的','虚幻的','淡然的','受伤的','雪白的','高高的','糟糕的','顺利的','闪闪的','羞涩的','缓慢的','迅速的','优秀的','聪明的','含糊的','俏皮的','淡淡的','坚强的','平淡的','欣喜的','能干的','灵巧的','友好的','机智的'

  );

  $name_wei=array("嚓茶","凉面","便当","毛豆","花生","可乐","灯泡","野狼","背包","眼神","缘分","雪碧","人生","牛排","蚂蚁","飞鸟","灰狼","斑马","汉堡","悟空","巨人","绿茶","大碗","墨镜","魔镜","煎饼","月饼","月亮","星星","芝麻","啤酒","玫瑰","大叔","小伙","太阳","树叶","芹菜","黄蜂","蜜粉","蜜蜂","信封","西装","外套","裙子","大象","猫咪","母鸡","路灯","蓝天","白云","星月","彩虹","微笑","摩托","板栗","高山","大地","大树","砖头","楼房","水池","鸡翅","蜻蜓","红牛","咖啡","枕头","大船","诺言","钢笔","刺猬","天空","飞机","大炮","冬天","洋葱","春天","夏天","秋天","冬日","航空","毛衣","豌豆","黑米","玉米","眼睛","老鼠","白羊","帅哥","美女","季节","鲜花","服饰","裙子","秀发","大山","火车","汽车","歌曲","舞蹈","老师","导师","方盒","大米","麦片","水杯","水壶","手套","鞋子","鼠标","手机","电脑","书本","奇迹","身影","香烟","夕阳","台灯","宝贝","未来","皮带","钥匙","心锁","故事","花瓣","滑板","画笔","画板","学姐","店员","电源","饼干","宝马","过客","大白","时光","石头","钻石","河马","犀牛","西牛","绿草","抽屉","柜子","往事","寒风","路人","橘子","耳机","鸵鸟","朋友","苗条","铅笔","钢笔","硬币","热狗","大侠","御姐","萝莉","毛巾","期待","盼望","白昼","黑夜","大门","黑裤","哑铃","板凳","枫叶","荷花","乌龟","衬衫","大神","草丛","早晨","心情","茉莉","流沙","蜗牛","猎豹","棒球","篮球","乐曲","电话","网络","世界","中心","老虎","鸭子","羽毛","翅膀","外套","书包","钢笔","冷风","烤鸡","大雁","音响","招牌","冰棍","帽子",
  );

  $t=rand(0,199);
  $w=rand(0,199);
  $name=$name_tou[$t].$name_wei[$w];
  return $name;
}


//这是一个PHP函数，名为`logmsg`。它接受两个参数：`$b`和`$msg`。`$b`是一个整数，`$msg`是一个字符串，默认值为'操作成功！'。
//
//函数的主要逻辑如下：
//
//1. 如果`$b`大于0，那么将数组`$arr`的`result`字段设置为200，`message`字段设置为`$msg`。
//2. 如果`$b`小于等于0，那么将数组`$arr`的`result`字段设置为500。如果`$msg`为空，那么将`message`字段设置为'操作失败！'，否则设置为`$msg`。
//3. 无论哪种情况，都将`$arr`的`id`字段设置为`$b`。
//4. 使用`json_encode`函数将数组`$arr`转换为JSON格式的字符串，并使用`echo`语句输出。
//5. 使用`exit`语句终止函数执行。
function logmsg($b, $msg = '操作成功！')
{
    if ($b > 0) {
        $arr['result'] = 200;
        $arr['message'] = $msg;
    } else {
        $arr['result'] = 500;
        if (empty($msg)) {
            $arr['message'] = '操作失败！';
        } else {
            $arr['message'] = $msg;
        }
    }
    $arr['id'] = $b;
    echo json_encode($arr);
    exit;
}
 


//这是一个PHP函数，名为`get_token`。
//它的主要功能是生成一个唯一的令牌（token），并将其存储在会话中和cookie中。
//以下是该函数的解析：
//1. 首先，函数检查会话中是否已经存在一个名为`KEY.'token'`的变量。
//如果不存在，则执行以下操作：
//   - 使用`uniqid(rand(), true)`生成一个唯一的字符串。
//   - 对该字符串进行MD5哈希运算，得到一个新的令牌。
//   - 将新令牌存储在会话变量`KEY.'token'`中。
//2. 如果会话中已经存在一个名为`KEY.'token'`的变量，则直接将其值赋给变量`$token`。
//3. 使用`setcookie`函数将令牌存储在cookie中。
//cookie的名称为`md5(KEY.'token')`，值为`$token`，有效期为24小时，路径为根目录。
//4. 最后，函数返回令牌`$token`。
//请注意，上述代码中的`KEY.'token'`是一个占位符，你需要将其替换为实际的键名。
function get_token(){

  if(empty($_SESSION[KEY.'token'])){
      $token = md5(uniqid(rand(), true));
      $_SESSION[KEY.'token'] = $token;
  }else{
     $token = $_SESSION[KEY.'token'];
  }
  setcookie(md5(KEY.'token'),$token,time()+3600*24,'/');
  return $token;

}



//这是一个名为`check_post`的PHP函数，它接受两个参数：`$arr`和`$config`。
//`$arr`是一个数组，`$config`是一个可选的配置数组，默认为空。
//函数首先获取当前时间戳并将其存储在变量`$now`中。然后，它尝试从cookie中获取一个名为`md5(KEY.'token')`的值，
//并将其存储在变量`$token`中。这里的`KEY`是一个未定义的常量，你需要将其替换为实际的键名。
//接下来，函数检查`$token`是否为空或者与`$_SESSION[KEY . 'token']`不相等。如果满足这些条件之一，函数将返回`false`。
// 否则，函数将返回`true`。
//
//这个函数的主要目的是验证用户是否具有有效的令牌（token），以便执行某些操作。
function  check_post($arr,$config=array()){
	$now = time();
    $token = $_COOKIE[md5(KEY.'token')];

	if(empty($token) or $token !=  $_SESSION[KEY . 'token']){
	   return false;
	}	
	return true;
}